---
import Banner from "../components/Banner.astro";
import Baz from "./Baz.astro";
import Panels from "../components/Panels.svelte";
import "../styles/global.css";
const { frontmatter } = Astro.props;
---

<Baz pageTitle={frontmatter.title}>
    <Banner metadata={frontmatter} />
    <div id="scrollDiv">
        <div id="tocHeader">
            <span> â†“ ToC </span>
            <span class="tocTitle">: {frontmatter.title}</span>
        </div>
        <div id="toc" class="hidden"></div>
    </div>
    <article>
        <slot />
    </article>

    <Panels client:load />
</Baz>

<style>
    article {
        background-color: white;
        position: relative;
        border-width: 0px 1px 1px 1px;
        border-color: var(--main-border);
        border-style: solid;
        padding: 10px;
        box-shadow: inset 0 0 0 1px white;
    }

    article :global(a) {
        color: var(--accent);
        text-decoration: none;
        font-weight: bold;
    }

    article :global(a):hover {
        background-color: var(--accent);
        color: white;
    }

    #scrollDiv {
        position: sticky;
        top: 52px;
        font-family: "Kode Mono Variable";
        font-weight: 500;
        font-size: 15px;
        line-height: 1;
        border: 1px solid var(--main-border);
        padding: 8px;
        color: white;
        background-color: var(--accent);
        text-transform: uppercase;
        box-shadow: inset 0 0 0px 1px var(--orange);
        display: hidden;
        z-index: 111;
    }

    #toc {
        max-height: 500px;
        overflow-y: hidden;
        padding-top: 8px;
    }

    #tocHeader > span {
        cursor: pointer;
    }

    #toc.hidden {
        display: none;
    }

    span.tocTitle {
        display: none;
    }
</style>

<script>
    //@ts-nocheck
    const scrollDiv = document.getElementById("scrollDiv");
    const tocHeader = document.getElementById("tocHeader");
    const tocTitle = document.querySelector(".tocTitle");
    const toc = document.getElementById("toc");

    function handleScroll() {
        if (window.scrollY > 200) {
            tocTitle.style.display = "inline"; // or 'block' depending on layout
        } else {
            tocTitle.style.display = "none";
        }
    }

    window.addEventListener("scroll", handleScroll);

    tocHeader.addEventListener("click", () => {
        if (toc.classList.contains("hidden")) {
            generateTOC();
            toc.classList.remove("hidden");

            setupTOC();
        } else {
            toc.classList.add("hidden");
        }
    });

    function scrollToHeading(target) {
        const navbar = document.querySelector("nav");
        const navbarHeight = navbar ? navbar.offsetHeight : 0;
        const scrollDivHeight = scrollDiv.offsetHeight;
        const totalOffset = navbarHeight + scrollDivHeight + 16;

        // get target position
        let top =
            target.getBoundingClientRect().top + window.scrollY - totalOffset;

        // this is for instances where you are below the target header's position and you want to
        // scroll back.
        const maxScroll =
            document.documentElement.scrollHeight - window.innerHeight;
        if (top > maxScroll) top = maxScroll;
        if (top < 0) top = 0;

        window.scrollTo({
            top,
            behavior: "smooth",
        });
    }

    function setupTOC() {
        toc.querySelectorAll("a").forEach((link) => {
            link.addEventListener("click", (e) => {
                e.preventDefault();
                const target = document.querySelector(
                    link.getAttribute("href"),
                );
                if (!target) return;
                scrollToHeading(target);
            });
        });
    }

    function generateTOC() {
        toc.innerHTML = ""; // clear previous TOC

        const article = document.querySelector("article");
        const headings = article.querySelectorAll("h1, h2, h3"); // adjust levels if needed

        if (!headings.length) return;

        const ul = document.createElement("ul");
        ul.style.listStyleType = "square";

        headings.forEach((h) => {
            if (!h.id) {
                h.id = h.textContent.trim().replace(/\s+/g, "-").toLowerCase();
            }

            const li = document.createElement("li");

            const link = document.createElement("a");
            link.classList.add("toc-a");
            link.href = `#${h.id}`;
            link.textContent = h.textContent;
            li.appendChild(link);
            ul.appendChild(li);
        });

        toc.appendChild(ul);
    }
</script>
