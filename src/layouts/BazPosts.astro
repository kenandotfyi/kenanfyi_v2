---
import Banner from "../components/Banner.astro";
import Baz from "./Baz.astro";
import Backlinks from "../components/Backlinks.astro";
import Panels from "../components/Panels.svelte";
import { Icon } from "astro-icon/components";
import "../styles/global.css";
import { generateOgImage } from "../lib/generate-og";

const { frontmatter, minutes } = Astro.props;

const published: Date = frontmatter.data.published;
const updated: Date | undefined = (frontmatter.data as any).updated;
const lastRelevantDate =
    updated && updated.getTime() !== published.getTime() ? updated : published;
const oneYearAgo = new Date(
    new Date().getFullYear() - 1,
    new Date().getMonth(),
    new Date().getDate(),
);
const isStale = lastRelevantDate < oneYearAgo;

const ogImage = await generateOgImage({
    title: frontmatter.data.title,
    collection: frontmatter.collection,
    id: frontmatter.id,
});
---

<Baz
    pageTitle={frontmatter.data.title}
    description={frontmatter.data.description}
    ogImage={ogImage}
    wide
>
    <div class="post-container">
        <Banner
            metadata={frontmatter.data}
            minutes={minutes}
            collection={frontmatter.collection}
        />
        {
            isStale && (
                <div class="stale-notice">
                    <Icon name="ph:hourglass-duotone" size="16" />
                    <span>
                        This post is over a year old. So, behold the wisdom
                        within!
                    </span>
                </div>
            )
        }
        <article class="post-body">
            <slot />
        </article>
        <Backlinks id={frontmatter.id} />
    </div>
    <Panels client:load slot="panels-outside-main" />
</Baz>

<style>
    /* Centers the combined text (65ch) + gap (3ch) + sidenote (35ch) area */
    .post-container {
        max-width: calc(65ch + 3ch + 35ch);
        margin: 0 auto;
    }

    .stale-notice {
        display: flex;
        align-items: flex-start;
        gap: 0.6rem;
        margin: 1.5rem 0;
        padding: 0.75rem 1rem;
        border: 1px solid var(--accent-bright);
        background: var(--bg-surface);
        font-family: var(--font-mono);
        font-size: 0.8rem;
        color: var(--fg-secondary);
        max-width: fit-content;
    }

    .stale-notice :global(svg) {
        flex-shrink: 0;
        margin-top: 1px;
        opacity: 0.7;
    }

    .post-body {
        max-width: 65ch;
        position: relative;
        overflow: visible;
    }

    /* Desktop: float sidenotes into right margin */
    :global(.sidenote) {
        float: right;
        clear: right;
        margin-right: -38ch;
        width: 35ch;
        font-size: 0.8rem;
        color: var(--fg-muted);
        padding: 0.6rem 1rem;
        background: var(--bg-raised);
        position: relative;
    }

    :global(.sidenote-number) {
        font-size: 0.75em;
        vertical-align: super;
        color: var(--accent);
        margin: 0 1px;
        cursor: default;
    }

    :global(.sidenote > sup) {
        color: var(--accent);
        font-size: 0.75em;
        margin-right: 3px;
    }

    /* Always hide the footnotes section */
    :global([data-footnotes]) {
        display: none;
    }

    :global(.post-divider) {
        display: flex;
        justify-content: center;
        margin: calc(var(--q) * 10) 0;
        color: var(--fg-muted);
        opacity: 0.4;
    }

    /* Mobile: sidenotes become inline blocks below the text */
    @media (max-width: 1050px) {
        :global(.sidenote) {
            float: none;
            clear: both;
            display: block;
            width: auto;
            margin-right: 0;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.6rem 1rem;
            background: var(--bg-raised);
            padding-top: 0.6rem;
        }
    }
</style>
